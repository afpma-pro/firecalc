#
# SPDX-License-Identifier: AGPL-3.0-or-later
# Copyright (C) 2025 Association Française du Poêle Maçonné Artisanal
#

# =============================================================================
# FireCalc Payments Backend - Docker Compose Configuration
# =============================================================================
# This file orchestrates the FireCalc payments backend service with SSL
# termination via nginx-ssl-proxy. The setup includes:
# - Backend service running the Scala payments application
# - Nginx SSL proxy for HTTPS termination and routing
# - Shared internal network for secure inter-service communication
# - Volume mounts for configuration and database persistence
#
# Usage:
#   docker-compose up -d              # Start all services in detached mode
#   docker-compose logs -f backend    # View backend logs
#   docker-compose down               # Stop and remove containers
#
# Environment Variables (via .env file):
#   UI_DOMAIN           - UI domain name (e.g., firecalc.staging.example.com)
#   API_DOMAIN          - API domain name (e.g., api.staging.example.com)
#   FIRECALC_ENV        - Environment name (staging, production, etc.)
# =============================================================================

services:
  # ===========================================================================
  # Backend Service - FireCalc Payments API
  # ===========================================================================
  # Scala-based payments backend service handling payment processing,
  # invoice generation, and database operations. This service is not directly
  # exposed to the internet; all traffic comes through the nginx-ssl-proxy.
  backend:
    # Build configuration
    build:
      context: ..                    # Build from project root
      dockerfile: docker/Dockerfile  # Use Dockerfile in docker/ directory
    
    image: firecalc-payments:latest
    container_name: firecalc-payments-backend
    
    # Restart policy: always restart unless explicitly stopped
    restart: unless-stopped
    
    # Environment variables
    # FIRECALC_ENV determines which configuration file to load
    # Additional env vars can be added via the .env file
    environment:
      - FIRECALC_ENV=${FIRECALC_ENV:-staging}
    
    # Load additional environment variables from .env file
    env_file:
      - .env
    
    # Volume mounts for configuration and data persistence
    volumes:
      # Configuration files (read-only)
      # Contains YAML/CONF files for application settings
      - ./configs:/app/configs:ro
      
      # Database directory (read-write)
      # SQLite database files with persistent storage
      - ./databases:/app/databases:rw
    
    # Network configuration
    # Only expose port internally to the docker network
    # Not published to host - only accessible via nginx-ssl-proxy
    networks:
      - firecalc-network
    
    # Expose port 8181 internally (not to host)
    expose:
      - "8181"
    
    # Health check configuration
    # Verifies the application is responsive
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8181/v1/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits (optional - uncomment and adjust as needed)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2.0'
    #       memory: 2G
    #     reservations:
    #       cpus: '1.0'
    #       memory: 1G
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "30"

  # ===========================================================================
  # UI Static File Server
  # ===========================================================================
  # Serves the FireCalc UI static files
  ui-server:
    image: nginx:alpine
    container_name: firecalc-ui-server
    
    restart: unless-stopped
    
    volumes:
      - ../web/dist-app:/usr/share/nginx/html:ro
      - ./nginx-ui-server.conf:/etc/nginx/conf.d/default.conf:ro
    
    networks:
      - firecalc-network
    
    healthcheck:
      test: ["CMD", "test", "-f", "/usr/share/nginx/html/index.html"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "30"

  # ===========================================================================
  # Nginx SSL Proxy - Unified SSL/TLS Termination
  # ===========================================================================
  # Single proxy handling both UI and API domains
  # Routes based on server_name to appropriate upstream
  nginx-ssl-proxy:
    image: danieldent/nginx-ssl-proxy:latest
    container_name: firecalc-ssl-proxy
    
    restart: unless-stopped
    
    ports:
      - "443:443"
      - "80:80"
    
    environment:
      # Primary domain for certificate (will handle both via custom config)
      - SERVERNAME=${UI_DOMAIN}
      - EXTRANAMES=${API_DOMAIN}
      - UPSTREAM=ui-server:80
      - HTTPS_REDIRECT=true
      - UI_DOMAIN=${UI_DOMAIN}
      - API_DOMAIN=${API_DOMAIN}
    
    env_file:
      - .env
    
    # Custom entrypoint to process template with environment variables
    entrypoint: /bin/sh
    command: >
      -c "envsubst '$${UI_DOMAIN} $${API_DOMAIN}' < /tmp/nginx-proxy-custom.conf.template > /etc/nginx/conf.d/default.conf &&
          exec /init"
    
    volumes:
      - letsencrypt-certs:/etc/letsencrypt
      - ui-webroot:/usr/share/nginx/html
      # Mount as template, will be processed by entrypoint
      - ./nginx-proxy-custom.conf:/tmp/nginx-proxy-custom.conf.template:ro
    
    depends_on:
      ui-server:
        condition: service_started
      backend:
        condition: service_healthy
    
    networks:
      - firecalc-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "30"

# =============================================================================
# Networks
# =============================================================================
# Custom bridge network for inter-service communication
# Provides DNS resolution between services using service names
networks:
  firecalc-network:
    driver: bridge
    # Optional: Custom network configuration
    # ipam:
    #   config:
    #     - subnet: 172.28.0.0/16

# =============================================================================
# Volumes
# =============================================================================
# Named volumes for data persistence
volumes:
  # Let's Encrypt certificates (shared for both domains)
  letsencrypt-certs:
    driver: local
  
  # Webroot for Let's Encrypt challenges
  ui-webroot:
    driver: local

# =============================================================================
# Production Deployment Notes
# =============================================================================
# 
# 1. DNS Configuration:
#    - Ensure DOMAIN in .env points to a valid DNS A/AAAA record
#    - DNS must resolve to the server's public IP address
#    - Allow time for DNS propagation before starting services
#
# 2. Firewall Configuration:
#    - Open port 443 (HTTPS) for incoming traffic
#    - Open port 80 (HTTP) for Let's Encrypt validation and redirects
#    - Ensure ports are accessible from the internet
#
# 3. Environment Variables (.env file):
#    Create a .env file in the docker/ directory with:
#    ```
#    UI_DOMAIN=firecalc.staging.example.com
#    API_DOMAIN=api.staging.example.com
#    FIRECALC_ENV=staging
#    # Optional: LETSENCRYPT_EMAIL=admin@example.com
#    ```
#
#    Note: Both domains must have DNS A/AAAA records pointing to this server
#
# 4. Pre-deployment Checklist:
#    - Build the application JAR: make package or sbt assembly
#    - Verify JAR exists at modules/payments/target/scala-3.7.3/firecalc-payments-assembly.jar
#    - Create configs/ directory with necessary YAML/CONF files
#    - Ensure databases/ directory exists (will be created if missing)
#    - Review and update .env file with production values
#
# 5. SSL Certificate Management:
#    - First run may take a few minutes to obtain certificates
#    - Monitor logs: docker-compose logs -f nginx-ssl-proxy
#    - Certificates auto-renew before expiration
#    - Volume letsencrypt-certs persists certificates
#
# 6. Monitoring and Maintenance:
#    - Check service health: docker-compose ps
#    - View logs: docker-compose logs -f [service_name]
#    - Restart services: docker-compose restart [service_name]
#    - Update services: docker-compose pull && docker-compose up -d
#
# 7. Backup Strategy:
#    - Backup databases/ directory regularly
#    - Backup letsencrypt-certs volume: docker run --rm -v letsencrypt-certs:/certs -v $(pwd):/backup alpine tar czf /backup/certs-backup.tar.gz -C /certs .
#    - Backup configs/ directory
#
# 8. Security Considerations:
#    - Services run as non-root users inside containers
#    - Backend not exposed to host, only via nginx proxy
#    - Use secrets management for sensitive data (not in .env)
#    - Regular security updates: docker-compose pull
#    - Review and rotate database encryption keys
#
# 9. Troubleshooting:
#    - Certificate issues: Check DNS resolution and port accessibility
#    - Backend not responding: Check health endpoint and logs
#    - Connection refused: Verify network configuration
#    - Database locked: Ensure proper volume permissions
#
# =============================================================================